From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: MidnightTale <midnighttale24@gmail.com>
Date: Sun, 20 Jul 2025 22:46:45 +0700
Subject: [PATCH] Waypoint thread safe


diff --git a/net/minecraft/server/waypoints/ServerWaypointManager.java b/net/minecraft/server/waypoints/ServerWaypointManager.java
index 7dc3f46c82dcdfa30438bc4016fb9fc068680341..75c248892b0ff7b49a623612c0bd546c906989c8 100644
--- a/net/minecraft/server/waypoints/ServerWaypointManager.java
+++ b/net/minecraft/server/waypoints/ServerWaypointManager.java
@@ -6,6 +6,8 @@ import com.google.common.collect.Sets;
 import com.google.common.collect.Table;
 import com.google.common.collect.Tables;
 import com.google.common.collect.Sets.SetView;
+
+import java.util.Collections;
 import java.util.HashSet;
 import java.util.Map;
 import java.util.Set;
@@ -16,32 +18,46 @@ import net.minecraft.world.waypoints.WaypointManager;
 import net.minecraft.world.waypoints.WaypointTransmitter;
 
 public class ServerWaypointManager implements WaypointManager<WaypointTransmitter> {
-    private final Set<WaypointTransmitter> waypoints = new HashSet<>();
-    private final Set<ServerPlayer> players = new HashSet<>();
-    private final Table<ServerPlayer, WaypointTransmitter, WaypointTransmitter.Connection> connections = HashBasedTable.create();
+    // atDeprecated start - Thread safe collections
+    private final Set<WaypointTransmitter> waypoints = Collections.synchronizedSet(new HashSet<>());
+    private final Set<ServerPlayer> players = Collections.synchronizedSet(new HashSet<>());
+    private final Table<ServerPlayer, WaypointTransmitter, WaypointTransmitter.Connection> connections = Tables.synchronizedTable(HashBasedTable.create());
+    // atDeprecated end
 
     @Override
     public void trackWaypoint(WaypointTransmitter waypoint) {
         // atDeprecated start - Force enabled waypoint
-        this.waypoints.add(waypoint);
-        for (ServerPlayer serverPlayer : this.players) {this.createConnection(serverPlayer, waypoint);}
+        synchronized (this) {
+            this.waypoints.add(waypoint);
+            for (ServerPlayer serverPlayer : this.players) {
+                this.createConnection(serverPlayer, waypoint);
+            }
+        }
         // atDeprecated end - Force enabled waypoint
     }
 
     @Override
     public void updateWaypoint(WaypointTransmitter waypoint) {
-        if (this.waypoints.contains(waypoint)) {
-            Map<ServerPlayer, WaypointTransmitter.Connection> map = Tables.transpose(this.connections).row(waypoint);
-            SetView<ServerPlayer> set = Sets.difference(this.players, map.keySet());
-
-            for (Entry<ServerPlayer, WaypointTransmitter.Connection> entry : ImmutableSet.copyOf(map.entrySet())) {
-                this.updateConnection(entry.getKey(), waypoint, entry.getValue());
-            }
+        // atDeprecated start - Thread safe
+        synchronized (this) {
+            if (this.waypoints.contains(waypoint)) {
+                Map<ServerPlayer, WaypointTransmitter.Connection> map = Tables.transpose(this.connections).row(waypoint);
+                Set<ServerPlayer> currentPlayers = ImmutableSet.copyOf(this.players);
+                SetView<ServerPlayer> set = Sets.difference(currentPlayers, map.keySet());
+
+                // Update existing connections
+                Set<Entry<ServerPlayer, WaypointTransmitter.Connection>> entries = ImmutableSet.copyOf(map.entrySet());
+                for (Entry<ServerPlayer, WaypointTransmitter.Connection> entry : entries) {
+                    this.updateConnection(entry.getKey(), waypoint, entry.getValue());
+                }
 
-            for (ServerPlayer serverPlayer : set) {
-                this.createConnection(serverPlayer, waypoint);
+                // Create new connections
+                for (ServerPlayer serverPlayer : set) {
+                    this.createConnection(serverPlayer, waypoint);
+                }
             }
         }
+        // atDeprecated end
     }
 
     @Override
@@ -53,41 +69,65 @@ public class ServerWaypointManager implements WaypointManager<WaypointTransmitte
 
     public void addPlayer(ServerPlayer player) {
         // atDeprecated start - Force enabled waypoint
-        this.players.add(player);
-        for (WaypointTransmitter waypointTransmitter : this.waypoints) {this.createConnection(player, waypointTransmitter);}
-        if (player.isTransmittingWaypoint()) {this.trackWaypoint((WaypointTransmitter)player);}
+        synchronized (this) {
+            this.players.add(player);
+            for (WaypointTransmitter waypointTransmitter : this.waypoints) {
+                this.createConnection(player, waypointTransmitter);
+            }
+            if (player.isTransmittingWaypoint()) {
+                this.trackWaypoint((WaypointTransmitter)player);
+            }
+        }
         // atDeprecated end - Force enabled waypoint
     }
 
     public void updatePlayer(ServerPlayer player) {
         // atDeprecated start - Force enabled waypoint
-        Map<WaypointTransmitter, WaypointTransmitter.Connection> map = this.connections.row(player);
-        SetView<WaypointTransmitter> set = Sets.difference(this.waypoints, map.keySet());
-        for (Entry<WaypointTransmitter, WaypointTransmitter.Connection> entry : ImmutableSet.copyOf(map.entrySet())) {this.updateConnection(player, entry.getKey(), entry.getValue());}
-        for (WaypointTransmitter waypointTransmitter : set) {this.createConnection(player, waypointTransmitter);}
+        synchronized (this) {
+            Map<WaypointTransmitter, WaypointTransmitter.Connection> map = this.connections.row(player);
+            SetView<WaypointTransmitter> set = Sets.difference(this.waypoints, map.keySet());
+            for (Entry<WaypointTransmitter, WaypointTransmitter.Connection> entry : ImmutableSet.copyOf(map.entrySet())) {
+                this.updateConnection(player, entry.getKey(), entry.getValue());
+            }
+            for (WaypointTransmitter waypointTransmitter : ImmutableSet.copyOf(set)) {
+                this.createConnection(player, waypointTransmitter);
+            }
+        }
         // atDeprecated end - Force enabled waypoint
     }
 
     public void removePlayer(ServerPlayer player) {
         // atDeprecated start - Force enabled waypoint
-        this.connections.row(player).values().removeIf(connection -> {
-            connection.disconnect();
-            return true;
-        });
-        this.untrackWaypoint((WaypointTransmitter)player);
-        this.players.remove(player);
+        synchronized (this) {
+            this.connections.row(player).values().removeIf(connection -> {
+                connection.disconnect();
+                return true;
+            });
+            this.untrackWaypoint((WaypointTransmitter)player);
+            this.players.remove(player);
+        }
         // atDeprecated end - Force enabled waypoint
     }
 
     public void breakAllConnections() {
-        this.connections.values().forEach(WaypointTransmitter.Connection::disconnect);
-        this.connections.clear();
+        // atDeprecated start - Thread safe
+        synchronized (this) {
+            Set<WaypointTransmitter.Connection> currentConnections = ImmutableSet.copyOf(this.connections.values());
+            currentConnections.forEach(WaypointTransmitter.Connection::disconnect);
+            this.connections.clear();
+        }
+        // atDeprecated end
     }
 
     public void remakeConnections(WaypointTransmitter waypoint) {
-        for (ServerPlayer serverPlayer : this.players) {
-            this.createConnection(serverPlayer, waypoint);
+        // atDeprecated start - Thread safe
+        synchronized (this) {
+            Set<ServerPlayer> currentPlayers = ImmutableSet.copyOf(this.players);
+            for (ServerPlayer serverPlayer : currentPlayers) {
+                this.createConnection(serverPlayer, waypoint);
+            }
         }
+        // atDeprecated end
     }
 
     public Set<WaypointTransmitter> transmitters() {
@@ -132,3 +172,4 @@ public class ServerWaypointManager implements WaypointManager<WaypointTransmitte
         }
     }
 }
+
